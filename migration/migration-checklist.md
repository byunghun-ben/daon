# 🚀 Supabase 마이그레이션 체크리스트

## 📋 마이그레이션 단계별 체크리스트

### 🏗️ **1단계: 사전 준비**

- [ ] 새 Supabase 계정 생성 및 로그인
- [ ] 새 Supabase 프로젝트 생성
- [ ] 프로젝트 정보 수집 (URL, API Keys, Database 정보)
- [ ] 기존 데이터베이스 백업 (선택사항)
- [ ] 마이그레이션 스크립트 다운로드

### 🔧 **2단계: 인프라 설정**

- [ ] **01-extensions.sql** 실행
  - [ ] uuid-ossp 확장 설치 확인
  - [ ] pgcrypto 확장 설치 확인
  - [ ] pg_stat_statements 확장 설치 확인

- [ ] **02-schema.sql** 실행
  - [ ] users 테이블 생성
  - [ ] children 테이블 생성
  - [ ] child_guardians 테이블 생성
  - [ ] activities 테이블 생성
  - [ ] diary_entries 테이블 생성
  - [ ] milestones 테이블 생성
  - [ ] growth_records 테이블 생성
  - [ ] oauth_states 테이블 생성
  - [ ] 모든 인덱스 생성 확인

### 🛡️ **3단계: 보안 설정**

- [ ] **03-rls-policies.sql** 실행
  - [ ] 모든 테이블에서 RLS 활성화
  - [ ] users 테이블 정책 (3개) 생성
  - [ ] children 테이블 정책 (4개) 생성
  - [ ] child_guardians 테이블 정책 (5개) 생성
  - [ ] activities 테이블 정책 (4개) 생성
  - [ ] diary_entries 테이블 정책 (4개) 생성
  - [ ] milestones 테이블 정책 (4개) 생성
  - [ ] growth_records 테이블 정책 (4개) 생성

### ⚙️ **4단계: 함수 및 트리거**

- [ ] **04-functions-triggers.sql** 실행
  - [ ] handle_updated_at() 함수 생성
  - [ ] generate_invite_code() 함수 생성
  - [ ] handle_new_child() 함수 생성
  - [ ] cleanup_expired_oauth_states() 함수 생성
  - [ ] 모든 테이블의 updated_at 트리거 생성
  - [ ] children 테이블의 after_insert 트리거 생성

### 📊 **5단계: 데이터 마이그레이션 (선택사항)**

- [ ] **05-data-export.sql** 실행 (기존 프로젝트에서)
  - [ ] 사용자 데이터 내보내기
  - [ ] 아이 데이터 내보내기
  - [ ] 보호자 관계 데이터 내보내기
  - [ ] 활동 데이터 내보내기
  - [ ] 일기 데이터 내보내기
  - [ ] 마일스톤 데이터 내보내기
  - [ ] 성장 기록 데이터 내보내기

- [ ] **06-data-import.sql** 실행 (새 프로젝트에서)
  - [ ] 내보낸 데이터를 INSERT 문으로 변환
  - [ ] 데이터 순서 확인 (외래 키 제약 조건)
  - [ ] 데이터 삽입 실행
  - [ ] 데이터 무결성 검증

### 🔗 **6단계: Storage 설정**

- [ ] Storage 버킷 생성
  - [ ] uploads 버킷
  - [ ] avatars 버킷
  - [ ] children-photos 버킷
  - [ ] diary-media 버킷

- [ ] Storage RLS 정책 설정
  - [ ] 업로드 정책
  - [ ] 조회 정책
  - [ ] 수정/삭제 정책

### 🛠️ **7단계: 환경 설정**

- [ ] **07-environment-config.md** 참조하여 설정
  - [ ] 모바일 앱 환경 변수 업데이트
  - [ ] 백엔드 환경 변수 업데이트
  - [ ] Supabase 클라이언트 설정 확인
  - [ ] API 클라이언트 설정 확인
  - [ ] 배포 플랫폼 환경 변수 업데이트

### ✅ **8단계: 검증 테스트**

- [ ] **08-verification-tests.sql** 실행
  - [ ] 스키마 검증 통과
  - [ ] 제약 조건 검증 통과
  - [ ] RLS 정책 검증 통과
  - [ ] 함수/트리거 검증 통과
  - [ ] 확장 기능 검증 통과
  - [ ] 데이터 무결성 검증 통과
  - [ ] 권한 검증 통과

### 🧪 **9단계: 기능 테스트**

- [ ] 애플리케이션 연결 테스트
  - [ ] 모바일 앱 → Supabase 연결
  - [ ] 백엔드 → Supabase 연결
  - [ ] API 클라이언트 연결

- [ ] 인증 기능 테스트
  - [ ] 이메일/비밀번호 로그인
  - [ ] 카카오 OAuth 로그인
  - [ ] 사용자 프로필 조회/수정

- [ ] 핵심 기능 테스트
  - [ ] 아이 등록/수정/삭제
  - [ ] 보호자 초대/수락
  - [ ] 활동 기록 CRUD
  - [ ] 일기 작성 CRUD
  - [ ] 성장 기록 CRUD
  - [ ] 파일 업로드/다운로드

### 🔄 **10단계: 최종 전환**

- [ ] DNS 설정 업데이트 (도메인 사용 시)
- [ ] CDN 캐시 무효화
- [ ] 모니터링 설정
- [ ] 기존 프로젝트 정리 (신중하게)

## 🚨 **주의사항**

### ⚠️ **보안 관련**
- [ ] API 키는 안전하게 보관
- [ ] 서비스 역할 키는 서버에서만 사용
- [ ] RLS 정책이 올바르게 설정되었는지 확인
- [ ] 개인정보는 익명화하여 마이그레이션

### ⚠️ **데이터 관련**
- [ ] 기존 데이터 백업 보관
- [ ] 점진적 마이그레이션 고려
- [ ] 데이터 무결성 검증 필수
- [ ] Storage 파일들 별도 마이그레이션

### ⚠️ **운영 관련**
- [ ] 서비스 중단 시간 최소화
- [ ] 롤백 계획 준비
- [ ] 사용자 공지 (필요시)
- [ ] 모니터링 강화

## 📝 **문제 해결**

### 🔧 **일반적인 문제들**

**스키마 생성 실패**
- 확장 기능이 먼저 설치되었는지 확인
- 권한이 충분한지 확인
- 기존 테이블과 이름 충돌 확인

**RLS 정책 오류**
- 정책 순서 확인
- auth.uid() 함수 사용 가능 여부 확인
- 서브쿼리 문법 확인

**데이터 삽입 실패**
- 외래 키 제약 조건 순서 확인
- UUID 형식 검증
- 필수 필드 누락 확인

**연결 오류**
- 환경 변수 값 확인
- 네트워크 연결 상태 확인
- API 키 유효성 확인

### 📞 **지원 요청**

문제가 해결되지 않는 경우:
1. 에러 메시지와 실행한 단계 기록
2. Supabase Dashboard의 로그 확인
3. 개발팀에 문의

## 🎉 **마이그레이션 완료**

모든 체크리스트가 완료되면:
- [ ] 팀원들에게 새 환경 정보 공유
- [ ] 기존 프로젝트 정리 계획 수립
- [ ] 운영 문서 업데이트
- [ ] 성능 모니터링 시작

**축하합니다! 🎊 마이그레이션이 성공적으로 완료되었습니다.**